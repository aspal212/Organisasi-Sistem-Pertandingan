
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Hasil Sistem Setengah Kompetisi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/style.css">
</head>

<body>
  <header>
    <h1 id="namaTurnamen">Nama Turnamen</h1>
    <h1 id="sistemPertandingan">Sistem Pertandingan</h1>
  </header>

  <main>
    <div class="container" id="konten-turnamen">
      <h2>Klasemen</h2>
      <div id="klasemen"></div>
      <h2>Jadwal Pertandingan</h2>
      <div id="jadwal-pertandingan"></div>
    </div>
    <div class="container">
      <button onclick="simpanHasilTurnamen()">Simpan ke LocalStorage</button>
      <button onclick="exportHasilTurnamen()">Export ke JSON</button>
      <button onclick="exportPDF()">Export ke PDF</button>
      <button onclick="kirimKeServer()">Kirim ke Server</button>
    </div>
  </main>

  <footer>
    <p><a href="/sistem/sistem_setengah_kompetisi.html">← Kembali ke Halaman Setengah Kompetisi</a></p>
        &copy; 2025 @a_imron - Semua hak dilindungi.
    <p><a href="/sistem/sistem_setengah_kompetisi.html" style="color:white;">← Kembali ke Halaman Setengah Kompetisi</a></p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    const namaTurnamen = localStorage.getItem("namaTurnamen") || "Turnamen Uji Coba";
    const sistemPertandingan = localStorage.getItem("sistemPertandingan") || "Setengah Kompetisi";
    const grups = JSON.parse(localStorage.getItem("grups")) || [["Tim A", "Tim B", "Tim C"]];
    let klasemenData = {};
    let hasilPertandingan = {};

    document.getElementById("namaTurnamen").textContent = namaTurnamen;
    document.getElementById("sistemPertandingan").textContent = sistemPertandingan;

    grups.forEach((grup, gIndex) => {
      klasemenData[gIndex] = {};
      hasilPertandingan[gIndex] = {};
      grup.forEach(p => {
        klasemenData[gIndex][p] = { main: 0, menang: 0, kalah: 0, poin: 0, selisih: 0, gf: 0, ga: 0 };
      });
    });

    function tampilkanJadwal(grups) {
      const jadwalDiv = document.getElementById("jadwal-pertandingan");
      jadwalDiv.innerHTML = "";
      grups.forEach((grup, gIndex) => {
        let html = `<h4>Grup ${String.fromCharCode(65+gIndex)}</h4><table><tr><th>Pertandingan</th><th>Skor</th><th>Aksi</th></tr>`;
        for (let i = 0; i < grup.length - 1; i++) {
          for (let j = i + 1; j < grup.length; j++) {
            const matchId = `${gIndex}-${i}-${j}`;
            html += `
              <tr>
                <td>${grup[i]} vs ${grup[j]}</td>
                <td>
                  <input type="number" min="0" id="score-${matchId}-A" style="width:50px"> -
                  <input type="number" min="0" id="score-${matchId}-B" style="width:50px">
                </td>
                <td>
                  <button onclick="simpanSkor(${gIndex}, '${grup[i]}', '${grup[j]}', 'score-${matchId}-A', 'score-${matchId}-B')">Simpan</button>
                </td>
              </tr>
            `;
          }
        }
        html += "</table>";
        jadwalDiv.innerHTML += html;
      });
    }

    function simpanSkor(gIndex, teamA, teamB, idA, idB) {
      const skorA = parseInt(document.getElementById(idA).value);
      const skorB = parseInt(document.getElementById(idB).value);
      if (isNaN(skorA) || isNaN(skorB)) return alert("Isi skor dulu!");
      const matchId = `${teamA}-${teamB}`;
      hasilPertandingan[gIndex][matchId] = { teamA, teamB, skorA, skorB };
      updateKlasemen(gIndex);
      renderKlasemen();
    }

    function updateKlasemen(gIndex) {
      Object.keys(klasemenData[gIndex]).forEach(p => {
        klasemenData[gIndex][p] = { main:0, menang:0, kalah:0, poin:0, selisih:0, gf:0, ga:0 };
      });
      Object.values(hasilPertandingan[gIndex]).forEach(m => {
        klasemenData[gIndex][m.teamA].main++;
        klasemenData[gIndex][m.teamB].main++;
        klasemenData[gIndex][m.teamA].gf += m.skorA;
        klasemenData[gIndex][m.teamA].ga += m.skorB;
        klasemenData[gIndex][m.teamB].gf += m.skorB;
        klasemenData[gIndex][m.teamB].ga += m.skorA;
        klasemenData[gIndex][m.teamA].selisih += m.skorA - m.skorB;
        klasemenData[gIndex][m.teamB].selisih += m.skorB - m.skorA;
        if (m.skorA > m.skorB) {
          klasemenData[gIndex][m.teamA].menang++;
          klasemenData[gIndex][m.teamB].kalah++;
          klasemenData[gIndex][m.teamA].poin += 3;
        } else if (m.skorB > m.skorA) {
          klasemenData[gIndex][m.teamB].menang++;
          klasemenData[gIndex][m.teamA].kalah++;
          klasemenData[gIndex][m.teamB].poin += 3;
        } else {
          klasemenData[gIndex][m.teamA].poin += 1;
          klasemenData[gIndex][m.teamB].poin += 1;
        }
      });
    }

    function renderKlasemen() {
      const klasemenDiv = document.getElementById("klasemen");
      klasemenDiv.innerHTML = "";
      grups.forEach((grup, gIndex) => {
        let html = `<h4>Grup ${String.fromCharCode(65+gIndex)}</h4><table><tr>
          <th>Peringkat</th><th>Peserta</th><th>Main</th><th>Menang</th><th>Kalah</th>
          <th>SM</th><th>SK</th><th>Selisih</th><th>Poin</th></tr>`;
        let arr = Object.entries(klasemenData[gIndex]).map(([nama, data]) => ({ nama, ...data }));
        arr.sort((a, b) => b.poin - a.poin || b.selisih - a.selisih || b.gf - a.gf || a.nama.localeCompare(b.nama));
        arr.forEach((p, idx) => {
          html += `<tr><td>${idx+1}</td><td>${p.nama}</td><td>${p.main}</td><td>${p.menang}</td>
            <td>${p.kalah}</td><td>${p.gf}</td><td>${p.ga}</td><td>${p.selisih}</td><td>${p.poin}</td></tr>`;
        });
        html += "</table>";
        klasemenDiv.innerHTML += html;
      });
    }

    function simpanHasilTurnamen() {
      const keyKlasemen = `klasemen_${namaTurnamen}`;
      const keyHasil = `hasil_${namaTurnamen}`;
      localStorage.setItem(keyKlasemen, JSON.stringify(klasemenData));
      localStorage.setItem(keyHasil, JSON.stringify(hasilPertandingan));
      alert("Hasil turnamen berhasil disimpan ke localStorage.");
    }

    function exportHasilTurnamen() {
      const hasil = {
        nama_turnamen: namaTurnamen,
        klasemen: klasemenData,
        hasil_pertandingan: hasilPertandingan
      };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(hasil, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `${namaTurnamen.replace(/\s+/g, '_')}_hasil.json`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }

    function exportPDF() {
      const element = document.getElementById("konten-turnamen");
      html2pdf().set({ margin: 10, filename: `${namaTurnamen.replace(/\s+/g, '_')}_hasil.pdf`, html2canvas: { scale: 2 } }).from(element).save();
    }

    function kirimKeServer() {
      const hasil = {
        nama_turnamen: namaTurnamen,
        klasemen: klasemenData,
        hasil_pertandingan: hasilPertandingan
      };
      fetch("https://example.com/api/simpan-turnamen", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(hasil)
      })
      .then(response => {
        if (!response.ok) throw new Error("Gagal menyimpan ke server");
        return response.json();
      })
      .then(data => {
        alert("Data berhasil dikirim ke server!");
        console.log("Respon server:", data);
      })
      .catch(error => {
        alert("Terjadi kesalahan saat mengirim data.");
        console.error(error);
      });
    }

    tampilkanJadwal(grups);
    renderKlasemen();
  </script>
</body>
</html>
